name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Selecione o ambiente'
        required: true
        default: 'development'
        type: choice
        options: 
          - production
          - development
      module:
        description: 'Selecione o modulo'
        required: true
        type: choice
        options: 
          - '01-connectivity'
          - '02-security'
          - '03-databases'
          - '04-application'

permissions:
  id-token: write 
  contents: read  

jobs:
  terraform:
    name: "Deploy: ${{ github.event.inputs.module }} em ${{ github.event.inputs.environment }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4    

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} 
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"

      - name: Terraform Init
        run: |
          TARGET_DIR="${{ github.workspace }}/infrastructure/${{ github.event.inputs.module }}"
          
          cd "$TARGET_DIR"

          rm -rf .terraform/modules
          
          RAW_MODULE_NAME="${{ github.event.inputs.module }}"
          CLEAN_NAME=$(echo $RAW_MODULE_NAME | sed 's/^[0-9]*-//')
          
          terraform init \
            -backend-config="key=jpn/${{ github.event.inputs.environment }}/${CLEAN_NAME}.tfstate" \
            -reconfigure \
            -upgrade

      - name: Terraform Plan
        id: plan
        run: |
          TARGET_DIR="${{ github.workspace }}/infrastructure/${{ github.event.inputs.module }}"
          VAR_FILE="${{ github.event.inputs.environment }}.auto.tfvars"
          
          cd "$TARGET_DIR"
          
          if [ ! -f "$VAR_FILE" ]; then
            echo "ERRO: O arquivo $VAR_FILE n√£o foi encontrado em $(pwd)"
            exit 1
          fi

          terraform plan -no-color -var-file="$VAR_FILE" -out=tfplan

      - name: Terraform Apply
        run: |
          TARGET_DIR="${{ github.workspace }}/infrastructure/${{ github.event.inputs.module }}"
          cd "$TARGET_DIR"
          terraform apply -auto-approve tfplan